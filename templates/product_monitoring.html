<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Monitoring - Compliance Checker</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin:0;
    font-family: 'Roboto', Arial, sans-serif;
    background:#f4f6f9;
    color:#333;
  }

  /* Navbar */
  .navbar {
    position: fixed; top:0; left:0; right:0; height:60px;
    background:#2F3C7E; color:white; display:flex; align-items:center;
    justify-content:space-between; padding:0 20px; z-index:1000;
  }
  .navbar h2 { margin:0; font-size:22px; }
  .navbar ul { list-style:none; display:flex; margin:0; padding:0; }
  .navbar ul li { margin-left:20px; }
  .navbar ul li a { color:white; text-decoration:none; font-weight:bold; padding:10px 12px; border-radius:5px; }
  .navbar ul li a:hover, .navbar ul li a.active { background:#1d2659; }
  .menu-toggle { display:none; font-size:24px; cursor:pointer; }

  /* Profile Icon & Dropdown */
  .profile-container { position: relative; display:inline-block; }
  .profile-icon { width:45px; height:45px; border-radius:50%; border:2px solid white; cursor:pointer; transition:0.3s; }
  .profile-icon:hover { transform: scale(1.1); }
  .dropdown-card {
    display:none;
    position:absolute;
    right:0;
    top:60px;
    background:white;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.25);
    padding:20px;
    width:280px;
    text-align:left;
    z-index:1001;
    font-family:'Roboto', sans-serif;
  }
  .dropdown-card.show { display:block; }

  .dropdown-card .profile-header {
    display:flex;
    align-items:center;
    gap:15px;
    margin-bottom:15px;
  }
  .dropdown-card .profile-header img {
    width:60px; height:60px; border-radius:50%; border:2px solid #2F3C7E;
  }
  .dropdown-card .profile-header div strong { font-size:16px; color:#2F3C7E; }
  .dropdown-card .profile-header div span { font-size:14px; color:#555; display:block; }
  .dropdown-card .profile-stats { font-size:14px; color:#333; margin-bottom:15px; }
  .dropdown-card hr { border:none; border-top:1px solid #eee; margin:10px 0; }
  .dropdown-card a {
    display:block; text-decoration:none; color:white; background:#DB5A5A; font-weight:bold;
    text-align:center; padding:10px 0; border-radius:6px; margin-top:5px; transition:0.3s;
  }
  .dropdown-card a:hover { background:#a63b3b; }

  @media(max-width:768px){
    .navbar ul { flex-direction:column; position:absolute; top:60px; left:0; right:0; background:#2F3C7E; display:none; }
    .navbar ul.show { display:flex; }
    .navbar ul li { margin:0; }
    .menu-toggle { display:block; }
  }

  /* Hero Section */
  .hero {
    background: linear-gradient(135deg, #2F3C7E, #70C1B3);
    color: white;
    text-align: center;
    border-radius: 12px;
    padding: 60px 20px;
    margin: 80px auto 30px auto;
    max-width: 1000px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .hero h1 {
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.2;
    animation: slideDown 1s ease;
  }
  .hero p {
    font-size: 20px;
    margin-bottom: 30px;
    max-width: 700px;
    animation: fadeIn 2s ease;
  }
  .hero button {
    background: #DB5A5A;
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 18px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    animation: slideUp 1s ease;
  }
  .hero button:hover { background: #a63b3b; transform: translateY(-3px); }

  @keyframes slideDown { 0% { transform: translateY(-50px); opacity:0; } 100% { transform: translateY(0); opacity:1; } }
  @keyframes slideUp { 0% { transform: translateY(50px); opacity:0; } 100% { transform: translateY(0); opacity:1; } }
  @keyframes fadeIn { 0% { opacity:0; } 100% { opacity:1; } }

  /* Main Content */
  .content { padding:20px; max-width:1000px; margin:0 auto; }

  /* Card Layout */
  .card-container { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-bottom:20px; }
  .card {
    flex:1; min-width:250px; max-width:300px; background:white; padding:20px;
    border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); transition:0.3s transform;
  }
  .card:hover { transform: translateY(-5px); }
  .card h2 { margin:0 0 10px 0; color:#2F3C7E; text-align:center; }
  .card label { font-weight:bold; display:block; margin-top:10px; }
  .card select, .card input[type="text"], .card input[type="file"] {
    width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ccc; transition:0.3s;
  }
  .card select:focus, .card input:focus { border-color:#2F3C7E; box-shadow:0 0 8px rgba(47,60,126,0.4); outline:none; }
  .card button { margin-top:15px; padding:12px 20px; background:#2F3C7E; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s; width:100%; }
  .card button:hover { background:#1d2659; transform: translateY(-3px); }

  /* Results Section */
  .result-card { background:white; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:15px; transition: transform 0.3s; }
  .result-card:hover { transform: translateY(-5px); }
  .compliant { color:green; font-weight:bold; }
  .non-compliant { color:red; font-weight:bold; }

  /* Category Products Section */
  .category-product-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border-left: 5px solid #2F3C7E;
    transition: transform 0.3s;
  }
  .category-product-card:hover { transform: translateY(-3px); }
  .product-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .product-title {
    font-size: 18px;
    font-weight: bold;
    color: #2F3C7E;
    margin: 0;
  }
  .compliance-status {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
  }
  .status-compliant {
    background: #d4edda;
    color: #155724;
  }
  .status-non-compliant {
    background: #f8d7da;
    color: #721c24;
  }
  .product-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }
  .detail-item {
    display: flex;
    flex-direction: column;
  }
  .detail-label {
    font-weight: bold;
    color: #555;
    font-size: 12px;
    margin-bottom: 5px;
  }
  .detail-value {
    color: #333;
    font-size: 14px;
  }
  .violations-list {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  .violation-item {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 14px;
  }
  .violation-item:last-child {
    margin-bottom: 0;
  }
  .report-button {
    background: #DB5A5A;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    font-size: 14px;
  }
  .report-button:hover {
    background: #a63b3b;
    transform: translateY(-2px);
  }

  /* Loading overlay */
  #loadingOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.45);
    display: none; align-items: center; justify-content: center; z-index: 3000;
  }
  .spinner {
    width: 56px; height: 56px; border: 6px solid #fff; border-top-color: #DB5A5A; border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Footer */
  footer { text-align:center; padding:15px; background:#2F3C7E; color:white; margin-top:20px; }
</style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <h2>Vigyantram</h2>
  
  <span class="menu-toggle" onclick="toggleMenu()">☰</span>
  <ul id="nav-links">
    <li><a href="/">Home</a></li>
    <li><a href="/dashboard">Dashboard</a></li>
    <li><a href="/product_monitoring" class="active">Product Monitoring</a></li>
    <li><a href="/violation_reports">Violation Reports</a></li>
    <li><a href="/categories">Categories/Brands</a></li>
    <li><a href="/geo_heatmap">Geo Heatmap</a></li>
    <li><a href="/rule_engine">Rule Engine</a></li>
  </ul>

  <!-- Profile Icon -->
  <div class="profile-container">
    <img src="/static/profile.png" alt="Profile" class="profile-icon" onclick="toggleDropdown()">
    <div class="dropdown-card" id="profileDropdown">
      <div class="profile-header">
        <img src="/static/profile.png" alt="Profile Pic">
        <div>
          <strong>Rohit Bavale</strong>
          <span>Email: rohit@example.com</span>
          <span>Role: Compliance Officer</span>
        </div>
      </div>
      <div class="profile-stats">
        Work Done: 50 Products Checked
      </div>
      <hr>
      
      <a href="/logout">Logout</a>
    </div>
  </div>
</div>

<!-- Hero Section -->
<div class="hero">
  <h1>AI-Powered Product Compliance Checker</h1>
  <p>Automatically scan e-commerce product listings to detect compliance with government rules and regulations.</p>
  <button onclick="document.getElementById('results').scrollIntoView({behavior:'smooth'})">Check a Product Now</button>
</div>

<div class="content">

  <!-- Cards for Inputs -->
  <div class="card-container">

    <!-- Card 1: Category + Time -->
    <div class="card">
      <h2>Choose Category & Time</h2>
      <form id="categoryTimeForm">
        <label for="category">Category:</label>
        <select id="category" name="category" onchange="loadCategoryProducts()">
          <option value="">All Categories</option>
          <option value="protein">Protein</option>
          <option value="mobile">Mobile</option>
          <option value="laptop">Laptop</option>
        </select>

        <label for="time">Time Filter:</label>
        <select id="time" name="time" onchange="loadCategoryProducts()">
          <option value="">All Time</option>
          <option value="latest">Latest</option>
          <option value="1_month">1 Month Ago</option>
          <option value="3_months">3 Months Ago</option>
        </select>

        <button type="button" onclick="loadCategoryProducts()">Check Compliance</button>
      </form>
    </div>

    <!-- Card 2: Paste Product Link -->
    <div class="card">
      <h2>Paste Product Link</h2>
      <form>
        <label for="url">Product URL:</label>
        <input type="text" id="url" name="url" placeholder="Paste e-commerce product link">
        <button type="submit">Check Compliance</button>
      </form>
    </div>

    <!-- Card 3: Upload Photo (Device or ESP32) -->
    <div class="card">
      <h2>Upload Product Photo</h2>
      <form id="photoForm" action="/check_product" method="POST" enctype="multipart/form-data">
        <label for="sourceSelect">Image Source:</label>
        <select id="sourceSelect" name="source">
          <option value="esp32" selected>Capture from ESP32-CAM</option>
          <option value="device">Select from device</option>
        </select>

        <div id="devicePicker" style="margin-top:8px;">
          <label for="image">Select Image:</label>
          <input type="file" id="image" name="image" accept="image/*">
        </div>

        <input type="hidden" id="snapshot_url" name="snapshot_url" value="{{ esp32_snapshot_url }}">
    
        <button id="checkBtn" type="submit" style="margin-top:12px;">Check Compliance</button>
      </form>
    </div>
    

    

  </div>

  <!-- Category Products Section -->
  <div id="categoryResults" style="display: none;">
    <h3 id="categoryResultsTitle">Category Products</h3>
    <div id="categoryProductsList">
      <!-- Category products will be populated by JavaScript -->
    </div>
  </div>

  <!-- Results Section -->
  <div id="results">
    <div id="sampleResults"></div>
    {% if results %}
    <div class="result-card">
      <h3>Processing Result</h3>
      {% if results.data %}
        <p><strong>product:</strong> {{ results.data.product or 'Uploaded Product' }}</p>
        <p><strong>mrp:</strong> {{ results.data.mrp or 'Not Found' }}</p>
        <p><strong>net_quantity:</strong> {{ results.data.net_quantity or 'Not Found' }}</p>
        <p><strong>manufacturer:</strong> {{ results.data.manufacturer or 'Not Found' }}</p>
        <p><strong>country:</strong> {{ results.data.country or 'Not Found' }}</p>
        <p><strong>care:</strong> {{ results.data.care or 'Not Found' }}</p>
        {% if results.data.issue %}
          <p><strong>issue:</strong> {{ results.data.issue }}</p>
      {% endif %}
      {% endif %}
      {% if results.compare %}
        <h4 style="margin-top:12px;">CSV Matches (≥ {{ results.compare.threshold }}%)</h4>
        {% if results.compare.has_match %}
          <div style="overflow:auto;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Name</th>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Price</th>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Score %</th>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Details</th>
                </tr>
              </thead>
              <tbody>
                {% for m in results.compare.top_matches %}
                <tr>
                  <td style="padding:8px;">{{ m.name }}</td>
                  <td style="padding:8px;">{{ m.price }}</td>
                  <td style="padding:8px;">{{ m.score_percent }}</td>
                  <td style="padding:8px;">{{ m.details[:120] }}{% if m.details and m.details|length > 120 %}...{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No CSV products matched at the chosen threshold.</p>
        {% endif %}
      {% endif %}

      {% if results.filename or results.processed_file %}
        <div style="display:flex; gap:10px; align-items:flex-start; margin-top:12px;">
          {% if results.filename %}
            <div style="flex:0 0 auto; width:32%;">
              <img data-preview src="/{{ results.filename }}" alt="Captured" style="width:100%; max-height:180px; object-fit:contain; border-radius:8px; cursor: zoom-in;" />
              <div style="font-size:12px; color:#555; text-align:center; margin-top:6px;">Captured</div>
            </div>
          {% endif %}
          {% if results.processed_file %}
            <div style="flex:0 0 auto; width:32%;">
              <img data-preview src="/{{ results.processed_file }}" alt="Processed" style="width:100%; max-height:180px; object-fit:contain; border-radius:8px; cursor: zoom-in;" />
              <div style="font-size:12px; color:#555; text-align:center; margin-top:6px;">Processed</div>
            </div>
          {% endif %}
        </div>
      {% endif %}
      {% if results.data and results.data.error %}
        <div class="violation-item" style="margin-top:12px; background:#f8d7da; border-color:#f5c6cb;">
          <strong>Capture Error:</strong> {{ results.data.error }}
        </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
  <script id="serverResultsData" type="application/json">{{ results|tojson if results else 'null' }}</script>

  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner" aria-label="Loading"></div></div>

  <!-- Download Report Button -->
<div class="result-card" style="text-align:center; margin-top:20px;">
  <form method="POST" action="{{ url_for('download_report') }}">
    <!-- Hidden input to send product_id -->
    <input type="hidden" name="product_id" value="{{ results.product_id }}">
    <button type="submit" 
            style="background:#DB5A5A; color:white; padding:12px 25px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px;">
      Download Report PDF
    </button>
  </form>
</div>


</div>

<!-- Footer -->
<footer>
  &copy; 2025 Vigyantram | AI Compliance Checker
</footer>

<script>
function toggleMenu() {
  document.getElementById('nav-links').classList.toggle('show');
}

// Profile Dropdown Toggle
function toggleDropdown() {
  document.getElementById('profileDropdown').classList.toggle('show');
}
window.onclick = function(event) {
  if (!event.target.matches('.profile-icon')) {
    var dropdowns = document.getElementsByClassName("dropdown-card");
    for (var i = 0; i < dropdowns.length; i++) {
      dropdowns[i].classList.remove('show');
    }
  }
}

// Load CSV data and populate sample results
async function loadSampleResults() {
  try {
    // Load CSV data
    const [mobileResponse, laptopResponse, proteinResponse] = await Promise.all([
      fetch('/data/mobile.csv'),
      fetch('/data/laptop.csv'),
      fetch('/data/protein.csv')
    ]);
    
    const mobileText = await mobileResponse.text();
    const laptopText = await laptopResponse.text();
    const proteinText = await proteinResponse.text();
    
    // Parse CSV data
    const mobileData = parseCSV(mobileText);
    const laptopData = parseCSV(laptopText);
    const proteinData = parseCSV(proteinText);
    
    // Generate sample results
    const sampleResults = generateSampleResults(mobileData, laptopData, proteinData);
    populateSampleResults(sampleResults);
    
  } catch (error) {
    console.error('Error loading sample results:', error);
    // Fallback to default results
    populateSampleResults([
      {
        status: 'compliant',
        title: 'Compliance Status: ✅ Compliant',
        data: {
          'Source URL': 'https://example.com/product/12345',
          'MRP': '₹499',
          'Net Quantity': '500g',
          'Manufacturer': 'Example Manufacturer',
          'Country of Origin': 'India',
          'Consumer Care': '1800-123-456'
        }
      },
      {
        status: 'non-compliant',
        title: 'Compliance Status: ❌ Non-Compliant',
        data: {
          'Source URL': 'https://example.com/product/67890',
          'Issue': 'MRP missing on label'
        }
      }
    ]);
  }
}

// Parse CSV function
function parseCSV(csvText) {
  const lines = csvText.split('\n');
  const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
  const data = [];
  
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim()) {
      const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index] || '';
      });
      data.push(row);
    }
  }
  return data;
}

// Generate sample results from CSV data
function generateSampleResults(mobileData, laptopData, proteinData) {
  const results = [];
  
  // Sample compliant result from mobile data
  if (mobileData.length > 0) {
    const mobile = mobileData[0];
    results.push({
      status: 'compliant',
      title: 'Compliance Status: ✅ Compliant',
      data: {
        'Product Name': mobile.name ? mobile.name.substring(0, 50) + '...' : 'Sample Mobile Product',
        'Source URL': mobile.product_link || 'https://example.com/mobile/12345',
        'Price': mobile.price || '₹12,999',
        'Details': mobile.details ? mobile.details.substring(0, 100) + '...' : 'Mobile phone specifications',
        'Manufacturer': 'Samsung',
        'Country of Origin': 'India',
        'Consumer Care': '1800-123-456'
      }
    });
  }
  
  // Sample non-compliant result from protein data
  if (proteinData.length > 0) {
    const protein = proteinData[0];
    results.push({
      status: 'non-compliant',
      title: 'Compliance Status: ❌ Non-Compliant',
      data: {
        'Product Name': protein['Product Name'] ? protein['Product Name'].substring(0, 50) + '...' : 'Sample Protein Product',
        'Source URL': protein['Product Link'] || 'https://example.com/protein/67890',
        'Price': protein.Price || '₹509',
        'Issue': 'Missing mandatory product information',
        'Details': 'Product lacks required compliance declarations'
      }
    });
  }
  
  return results;
}

// No-op: demo results removed
function populateSampleResults(_) {}

// Removed demo sample results to avoid showing placeholder compliance cards

// Upload-only: show preview when choosing a file
(function(){
  const form = document.getElementById('photoForm');
  const sourceSelect = document.getElementById('sourceSelect');
  const devicePicker = document.getElementById('devicePicker');
  const fileInput = document.getElementById('image');
  const snapshotUrl = document.getElementById('snapshot_url');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const checkBtn = document.getElementById('checkBtn');

  function onSourceChange(){
    const src = sourceSelect.value;
    if(src === 'device'){
      devicePicker.style.display = 'block';
      // Allow selecting a file
      if(fileInput){ fileInput.disabled = false; fileInput.value = ''; }
    } else {
      devicePicker.style.display = 'none';
      // Prevent accidental file submission
      if(fileInput){ fileInput.disabled = true; fileInput.value = ''; }
    }
  }

  // Preview for device file
  if(fileInput){
    fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = e => {
        const previewHolderId = 'previewHolder';
        let holder = document.getElementById(previewHolderId);
        if(!holder){
          holder = document.createElement('div');
          holder.id = previewHolderId;
          holder.style.marginTop = '10px';
          devicePicker.appendChild(holder);
        }
        holder.innerHTML = '<label>Preview:</label><img style="width:100%; max-height:260px; object-fit:contain; border:1px solid #eee; border-radius:8px;" src="'+e.target.result+'"/>';
      };
      reader.readAsDataURL(f);
    });
  }

  if(form){
    form.addEventListener('submit', function(e){
      const src = sourceSelect.value;
      if(src === 'device'){
        if(!fileInput.files.length){
          e.preventDefault();
          alert('Please select an image file.');
          return false;
        }
      } else if(src === 'esp32'){
        // Ensure snapshot_url exists; backend /check_product will fetch and process
        if(!snapshotUrl || !snapshotUrl.value){
        e.preventDefault();
          alert('ESP32 snapshot URL is not configured.');
        return false;
      }
      }
      // Show loading overlay and prevent double submit
      if(loadingOverlay){ loadingOverlay.style.display = 'flex'; }
      if(checkBtn){ checkBtn.disabled = true; checkBtn.textContent = 'Processing...'; }
    });
  }

  if(sourceSelect){ sourceSelect.addEventListener('change', onSourceChange); }
  onSourceChange();
})();

// -----------------------------
// Render server results if provided
// -----------------------------
// Server results are rendered by Jinja; suppress client-side duplication
</script>

<!-- Simple image preview modal -->
<div id="imgModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
  <img id="imgModalContent" src="" alt="Preview" style="max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.5);" />
</div>

<script>
// click-to-zoom for processed/captured images
document.addEventListener('click', function(e){
  if(e.target && e.target.matches('img[data-preview]')){
    const modal = document.getElementById('imgModal');
    const modalImg = document.getElementById('imgModalContent');
    modalImg.src = e.target.src;
    modal.style.display = 'flex';
  } else if(e.target && (e.target.id === 'imgModal' || e.target.id === 'imgModalContent')){
    document.getElementById('imgModal').style.display = 'none';
  }
});
</script>

</body>
</html>