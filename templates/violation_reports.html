<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Violation Reports - Compliance Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Roboto', Arial, sans-serif; background:#f4f6f9; color:#333; }

  /* Navbar */
  .navbar {
    position: fixed; top:0; left:0; right:0; height:60px;
    background:#2F3C7E; color:white;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 20px; z-index:1000;
  }
  .navbar h2 { margin:0; font-size:22px; }
  .navbar ul { list-style:none; display:flex; margin:0; padding:0; }
  .navbar ul li { margin-left:20px; }
  .navbar ul li a { color:white; text-decoration:none; font-weight:bold; padding:10px 12px; border-radius:5px; }
  .navbar ul li a:hover, .navbar ul li a.active { background:#1d2659; }
  .menu-toggle { display:none; font-size:24px; cursor:pointer; }

  @media(max-width:768px){
    .navbar ul { flex-direction:column; position:absolute; top:60px; left:0; right:0; background:#2F3C7E; display:none; }
    .navbar ul.show { display:flex; }
    .navbar ul li { margin:0; }
    .menu-toggle { display:block; }
  }

  /* Profile Dropdown */
  .profile-container { position: relative; display:inline-block; }
  .profile-icon { width:45px; height:45px; border-radius:50%; border:2px solid white; cursor:pointer; transition:0.3s; }
  .profile-icon:hover { transform: scale(1.1); }
  .dropdown-card {
    display:none;
    position:absolute; right:0; top:60px;
    background:white; border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.25);
    padding:20px; width:280px; text-align:left; z-index:1001;
  }
  .dropdown-card.show { display:block; }
  .dropdown-card .profile-header { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
  .dropdown-card .profile-header img { width:60px; height:60px; border-radius:50%; border:2px solid #2F3C7E; }
  .dropdown-card .profile-header div strong { font-size:16px; color:#2F3C7E; }
  .dropdown-card .profile-header div span { font-size:14px; color:#555; display:block; }
  .dropdown-card .profile-stats { font-size:14px; color:#333; margin-bottom:15px; }
  .dropdown-card hr { border:none; border-top:1px solid #eee; margin:10px 0; }
  .dropdown-card a { display:block; text-decoration:none; color:white; background:#DB5A5A; font-weight:bold; text-align:center; padding:10px 0; border-radius:6px; margin-top:5px; transition:0.3s; }
  .dropdown-card a:hover { background:#a63b3b; }

  /* Hero Section */
  .hero {
    background: linear-gradient(135deg, #2F3C7E, #70C1B3);
    color:white; text-align:center;
    border-radius:12px; padding:60px 20px; margin:80px auto 30px auto; max-width:1200px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
  }
  .hero h1 { font-size:42px; margin-bottom:20px; line-height:1.2; animation: slideDown 1s ease; }
  .hero p { font-size:20px; margin-bottom:30px; max-width:800px; margin-left:auto; margin-right:auto; animation: fadeIn 2s ease; }
  .hero button {
    background:#DB5A5A; color:white; border:none; padding:15px 30px; font-size:18px;
    border-radius:8px; font-weight:bold; cursor:pointer; transition:0.3s; animation: slideUp 1s ease;
  }
  .hero button:hover { background:#a63b3b; transform: translateY(-3px); }

  @keyframes slideDown {0% { transform: translateY(-50px); opacity:0; } 100% { transform: translateY(0); opacity:1; }}
  @keyframes slideUp {0% { transform: translateY(50px); opacity:0; } 100% { transform: translateY(0); opacity:1; }}
  @keyframes fadeIn {0% { opacity:0; } 100% { opacity:1; }}

  /* Content */
  .content { padding:20px; max-width:1200px; margin:0 auto; }

  /* Cards */
  .cards { display:flex; gap:20px; justify-content:space-around; flex-wrap:wrap; margin-bottom:20px; }
  .card { flex:1; min-width:200px; background:white; padding:20px; border-radius:12px; box-shadow:0 3px 6px rgba(0,0,0,0.1); text-align:center; border-top:4px solid #2F3C7E; }
  .card h2 { margin:10px 0; color:#2F3C7E; }

  /* Filters */
  .filters { background:white; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; flex-wrap:wrap; gap:10px; }
  .filters input, .filters select, .filters button { padding:8px; border-radius:6px; border:1px solid #ccc; }
  .filters button { background:#2F3C7E; color:white; border:none; cursor:pointer; }
  .filters button:hover { background:#1d2659; }

  /* Table */
  table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
  th,td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
  th { background:#A8D0E6; color:#333; }
  tr:hover { background:#f1f1f1; transition:0.3s; }
  .compliant { color:green; font-weight:bold; }
  .non-compliant { color:red; font-weight:bold; }

  /* Footer */
  footer { text-align:center; padding:15px; background:#2F3C7E; color:white; margin-top:20px; border-radius:12px; }

</style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <h2>Vigyantram</h2>
  <span class="menu-toggle" onclick="toggleMenu()">â˜°</span>
  <ul id="nav-links">
    <li><a href="{{ url_for('home') }}">Home</a></li>
    <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
    <li><a href="{{ url_for('product_monitoring') }}">Product Monitoring</a></li>
    <li><a href="{{ url_for('violation_reports') }}" class="active">Violation Reports</a></li>
    <li><a href="{{ url_for('categories') }}">Categories/Brands</a></li>
    <li><a href="{{ url_for('geo_heatmap') }}">Geo Heatmap</a></li>
    <li><a href="{{ url_for('rule_engine') }}">Rule Engine</a></li>
  </ul>

  <!-- Profile Icon -->
  <div class="profile-container">
    <img src="/static/profile.png" alt="Profile" class="profile-icon" onclick="toggleDropdown()">
    <div class="dropdown-card" id="profileDropdown">
      <div class="profile-header">
        <img src="/static/profile.png" alt="Profile Pic">
        <div>
          <strong>Rohit Bavale</strong>
          <span>Email: rohit@example.com</span>
          <span>Role: Compliance Officer</span>
        </div>
      </div>
      <div class="profile-stats">
        Work Done: 50 Violations Reviewed
      </div>
      <hr>
      <a href="/logout">Logout</a>
    </div>
  </div>
</div>

<!-- Hero Section -->
<div class="hero">
  <h1>Violation Reports</h1>
  <p>Monitor and analyze all product violations across sellers and categories. Quickly identify high-severity issues and take corrective actions.</p>
  <button onclick="document.querySelector('.content').scrollIntoView({behavior:'smooth'})">View Violations</button>
</div>

<!-- Content -->
<div class="content">

  <!-- Top Cards -->
  <div class="cards">
    <div class="card"><h2 id="totalViolations">0</h2><p>Total Violations</p></div>
    <div class="card"><h2 id="highSeverity">0</h2><p>High Severity</p></div>
    <div class="card"><h2 id="mediumSeverity">0</h2><p>Medium Severity</p></div>
    <div class="card"><h2 id="lowSeverity">0</h2><p>Low Severity</p></div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input type="text" id="productFilter" placeholder="Search Product">
    <input type="text" id="sellerFilter" placeholder="Search Seller">
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
    <select id="statusFilter">
      <option value="">All Status</option>
      <option value="Open">Open</option>
      <option value="Resolved">Resolved</option>
    </select>
    <button onclick="applyFilter()">Filter</button>
  </div>

  <!-- Violation Table -->
  <table id="violationTable">
    <thead>
      <tr>
        <th>Product</th>
        <th>Seller</th>
        <th>Issue</th>
        <th>Severity</th>
        <th>Detected At</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<footer>
  &copy; 2025 Vigyantram | AI Compliance Dashboard
</footer>

<script>
// Function to parse CSV data
function parseCSV(csvText) {
  const lines = csvText.split('\n');
  const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
  const data = [];
  
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim()) {
      const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index] || '';
      });
      data.push(row);
    }
  }
  return data;
}

// Function to transform product data into violation format
function transformToViolations(products, category) {
  const violations = [];
  const issues = [
    "Missing product information",
    "Incorrect pricing",
    "Incomplete specifications", 
    "Missing warranty details",
    "Inaccurate product description",
    "Missing safety information",
    "Incorrect weight/size",
    "Missing certification details"
  ];
  
  const severities = ["High", "Medium", "Low"];
  const statuses = ["Open", "Resolved"];
  const sellers = ["Flipkart", "Amazon", "Myntra", "Nykaa", "BigBasket", "Grofers"];
  
  products.forEach((product, index) => {
    if (product.name && product.price) {
      violations.push({
        title: product.name.substring(0, 50) + (product.name.length > 50 ? "..." : ""),
        seller: sellers[index % sellers.length],
        issue: issues[index % issues.length],
        severity: severities[index % severities.length],
        detected_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        status: statuses[index % statuses.length],
        category: category
      });
    }
  });
  
  return violations;
}

// Load CSV data and create violations
let violations = [];

// Function to load CSV files
async function loadCSVData() {
  try {
    // Load mobile data
    const mobileResponse = await fetch('/data/mobile.csv');
    const mobileText = await mobileResponse.text();
    const mobileData = parseCSV(mobileText);
    const mobileViolations = transformToViolations(mobileData.slice(0, 20), "Electronics");
    
    // Load laptop data  
    const laptopResponse = await fetch('/data/laptop.csv');
    const laptopText = await laptopResponse.text();
    const laptopData = parseCSV(laptopText);
    const laptopViolations = transformToViolations(laptopData.slice(0, 15), "Electronics");
    
    // Load protein data
    const proteinResponse = await fetch('/data/protein.csv');
    const proteinText = await proteinResponse.text();
    const proteinData = parseCSV(proteinText);
    const proteinViolations = transformToViolations(proteinData.slice(0, 15), "FMCG");
    
    // Combine all violations
    violations = [...mobileViolations, ...laptopViolations, ...proteinViolations];
    
    // Update category filter options
    updateCategoryFilter();
    
    // Render the table with real data
    renderTable(violations);
    
  } catch (error) {
    console.error('Error loading CSV data:', error);
    // Fallback to dummy data if CSV loading fails
    violations = [
      {title:"Milk Pack 500ml", seller:"DairyMart", issue:"Wrong weight", severity:"High", detected_at:"2025-09-20", status:"Open", category:"FMCG"},
      {title:"LED TV 32inch", seller:"ElectroShop", issue:"Missing declaration", severity:"Medium", detected_at:"2025-09-18", status:"Resolved", category:"Electronics"},
      {title:"T-Shirt L", seller:"FashionHub", issue:"Incorrect label", severity:"Low", detected_at:"2025-09-19", status:"Open", category:"Apparel"},
      {title:"Chocolate Box", seller:"SweetMart", issue:"Wrong price", severity:"Medium", detected_at:"2025-09-21", status:"Open", category:"FMCG"},
      {title:"Smartphone X", seller:"ElectroShop", issue:"Missing info", severity:"High", detected_at:"2025-09-22", status:"Resolved", category:"Electronics"},
    ];
    renderTable(violations);
  }
}

// Function to update category filter options based on actual data
function updateCategoryFilter() {
  const categoryFilter = document.getElementById("categoryFilter");
  const categories = [...new Set(violations.map(v => v.category))];
  
  // Clear existing options except "All Categories"
  categoryFilter.innerHTML = '<option value="">All Categories</option>';
  
  // Add categories from actual data
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    categoryFilter.appendChild(option);
  });
}

function renderTable(data){
  const tbody = document.querySelector("#violationTable tbody");
  tbody.innerHTML = "";
  let high=0, medium=0, low=0;
  data.forEach(v=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.title}</td>
      <td>${v.seller}</td>
      <td>${v.issue}</td>
      <td>${v.severity}</td>
      <td>${v.detected_at}</td>
      <td class="${v.status==='Open'?'non-compliant':'compliant'}">${v.status}</td>
    `;
    tbody.appendChild(tr);
    if(v.severity==="High") high++;
    else if(v.severity==="Medium") medium++;
    else low++;
  });
  document.getElementById("totalViolations").innerText = data.length;
  document.getElementById("highSeverity").innerText = high;
  document.getElementById("mediumSeverity").innerText = medium;
  document.getElementById("lowSeverity").innerText = low;
}

function applyFilter(){
  const product = document.getElementById("productFilter").value.toLowerCase();
  const seller = document.getElementById("sellerFilter").value.toLowerCase();
  const category = document.getElementById("categoryFilter").value;
  const status = document.getElementById("statusFilter").value;

  const filtered = violations.filter(v=>{
    return (!product || v.title.toLowerCase().includes(product)) &&
           (!seller || v.seller.toLowerCase().includes(seller)) &&
           (!category || v.category===category) &&
           (!status || v.status===status);
  });
  renderTable(filtered);
}

// Load CSV data and initialize
loadCSVData();

function toggleMenu(){
  document.getElementById('nav-links').classList.toggle('show');
}

function toggleDropdown(){
  document.getElementById('profileDropdown').classList.toggle('show');
}

window.onclick = function(event){
  if(!event.target.matches('.profile-icon')){
    document.getElementById('profileDropdown').classList.remove('show');
  }
}
</script>
</body>
</html>
